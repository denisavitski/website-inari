---
import Icon from './Icon.astro'

export interface Props {
  class?: string
  opened?: boolean | undefined
  counter?: number
}

const { class: className, opened = false, counter = 10, ...rest } = Astro.props
---

<!-- 
  Можно указать атрибут counter для отображения изначального количества итемов в корзине
  <e-basket-button counter="10">

  либо через window.globalStore.productsNumber.value = 10
-->
<e-basket-button
  {...rest}
  class:list={['basket-button', className, { opened }]}
  {counter}
>
  <a
    class="basket-button__link"
    href={opened ? undefined : '/basket'}
    onclick={opened ? 'history.back();' : ''}
  >
    <div class="basket-button__face">
      <div class="f-d-16-s basket-button__name">Корзина</div>
      <Icon
        class="basket-button__icon"
        name="basket"
      />
    </div>
    <div class="f-d-16-s f-m-14-s basket-button__value"></div>
    <Icon
      class="basket-button__back-icon"
      name="tailless-arrow"
    />
  </a>
</e-basket-button>

<style is:global>
  .basket-button {
    --type: toggle;

    padding: 0 1.6rem;
    height: 4rem;

    display: inline-block;

    color: var(--color-primary-2);
    background-color: var(--color-primary-3);
    border-radius: var(--border-radius-1);
    cursor: pointer;

    user-select: none;

    @media (min-width: 769px) {
      &.opened {
        cursor: default;
      }
    }

    @media (max-width: 768px) {
      padding: 0 0.4rem;
      height: 3.2rem;

      &.opened {
        width: 3.2rem;
      }
    }
  }

  .basket-button__link {
    height: 100%;
    display: inline-flex;
    align-items: center;

    @media (min-width: 769px) {
      .basket-button.opened & {
        pointer-events: none;
      }
    }
  }

  .basket-button__face {
    display: flex;
    align-items: center;
    gap: 0.8rem;

    @media (max-width: 768px) {
      .basket-button.opened & {
        display: none;
      }
    }
  }

  .basket-button__name {
    @media (max-width: 768px) {
      display: none;
    }
  }

  .basket-button__icon {
    width: 2.4rem;
    height: 2.4rem;
    fill: var(--color-primary-2);
  }

  .basket-button__value {
    --line-width: 0.2rem;
    --padding: 0.8rem;

    position: relative;

    padding-left: var(--padding);
    margin-left: calc(var(--padding) - var(--line-width));
    font-variant-numeric: tabular-nums;

    display: none;

    .basket-button.has-items & {
      display: block;
    }

    @media (max-width: 768px) {
      .basket-button.opened & {
        display: none;
      }
    }

    &::after {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;

      height: 1.6rem;
      width: var(--line-width);
      background-color: var(--color-primary-2);
      border-radius: 100rem;

      transform: translateY(-50%) scaleY(1);
      transform-origin: top;
    }

    @media (max-width: 768px) {
      --padding: 0.8rem;
      padding-right: 0.4rem;
    }
  }

  .basket-button__back-icon {
    width: 2.4rem;
    height: 2.4rem;
    transform: scaleX(-1);

    fill: var(--color-primary-2);

    display: none;

    @media (max-width: 768px) {
      .basket-button.opened & {
        display: block;
      }
    }
  }
</style>

<script>
  import { globalStore } from '@stores/globalStore'
  import { clamp } from 'aptechka/utils'

  export class BasketButtonElement extends HTMLElement {
    #valueElement: HTMLElement | null = null
    #counter = 0

    public set(value: number) {
      this.#counter = clamp(value, 0, Infinity)

      if (this.#valueElement) {
        if (value) {
          this.#valueElement.textContent = value.toString()
          this.classList.add('has-items')
        } else {
          this.classList.remove('has-items')
          this.#valueElement.textContent = ''
        }
      }
    }

    public shift(value: number) {
      this.set(this.#counter + value)
    }

    protected connectedCallback() {
      this.#valueElement = this.querySelector('.basket-button__value')

      const counterValue = this.getAttribute('counter')

      if (counterValue) {
        globalStore.productsNumber.value = parseInt(counterValue)
      }

      globalStore.productsNumber.subscribe(this.#basketChangeListener)
    }

    protected disconnectedCallback() {
      globalStore.productsNumber.unsubscribe(this.#basketChangeListener)
    }

    #basketChangeListener = () => {
      this.set(globalStore.productsNumber.value)
    }
  }

  if (!customElements.get('e-basket-button')) {
    customElements.define('e-basket-button', BasketButtonElement)
  }

  declare global {
    interface HTMLElementTagNameMap {
      'e-basket-button': BasketButtonElement
    }
  }
</script>
